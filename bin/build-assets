#!/bin/bash -x
ASSETS=`realpath $(dirname $0)/../assets`
UNDERBAR=the_underbar
UNDERBAR_SVG=$ASSETS/$UNDERBAR.svg

# FAVICON

# main icon in various sizes
for SIZE in 16 32 48 64 ; do
    convert \
        -background none \
        -density 1000 \
        -resize ${SIZE}x${SIZE} \
        $UNDERBAR_SVG \
        $ASSETS/favicon-${SIZE}.png
done

# merge all in a single icon
convert \
    $ASSETS/favicon-16.png \
    $ASSETS/favicon-32.png \
    $ASSETS/favicon-48.png \
    $ASSETS/favicon-64.png \
    $ASSETS/../favicon.ico

rm $ASSETS/favicon-*.png

# LOGO
for SIZE in 80 120 800 ; do

    # the strategy is to define images individually and to stack them as needed
    # everything is done proportionaly to the size of the target image

    # define the base logo (takes 90% of the image, with 5% margin around it)
    LOGO_SIZE=$( convert xc: -format "%[fx:$SIZE*.90]" info: )
    LOGO_MARGIN=$( convert xc: -format "%[fx:$SIZE*.05]" info: )
    LOGO_IMG=(
        \( -density 1000 \-background none -resize ${LOGO_SIZE}x${LOGO_SIZE} $UNDERBAR_SVG \) \
        -geometry +$LOGO_MARGIN+$LOGO_MARGIN -composite \
    )
    convert -size ${SIZE}x${SIZE} \
        xc:white \
	"${LOGO_IMG[@]}" \
        -flatten \
        $ASSETS/the_underbar-${SIZE}px.png

    # a grid on the 90% square for debugging
    # add with:
    #     "${DEBUG_IMG[@]}" -flatten \
    DEBUG_STROKE=$( convert xc: -format "%[fx:$SIZE*.02]" info: )
    DEBUG_MIN=$( convert xc: -format "%[fx:$SIZE*.05]" info: )
    DEBUG_MAX=$( convert xc: -format "%[fx:$SIZE*.95]" info: )
    DEBUG_IMG=(
        \( -stroke gray -fill none -draw "stroke-width $DEBUG_STROKE rectangle $DEBUG_MIN,$DEBUG_MIN $DEBUG_MAX,$DEBUG_MAX" \) \
    )

    # EPISODE 0
    CAMEL_SVG=$ASSETS/perl-camel.svg
    CAMEL_SIZE=$( convert xc: -format "%[fx:$SIZE*.40]" info: )
    CAMEL_X=$( convert xc: -format "%[fx:$SIZE*.55]" info: )
    CAMEL_Y=$( convert xc: -format "%[fx:$SIZE*.05]" info: )
    CAMEL_IMG=(
        \( -density 100 -background none -resize ${CAMEL_SIZE}x${CAMEL_SIZE} $CAMEL_SVG \) \
        -geometry +$CAMEL_X+$CAMEL_Y -composite \
    )
    convert -size ${SIZE}x${SIZE} \
	xc:white \
	"${CAMEL_IMG[@]}" \
	"${LOGO_IMG[@]}" \
        -flatten \
        $ASSETS/the_underbar-000-${SIZE}px.png

    # EPISODE 1
    VERSION_SIZE=$( convert xc: -format "%[fx:$SIZE*.45]" info: )
    VERSION_X=$( convert xc: -format "%[fx:$SIZE*.05]" info: )
    VERSION_Y=$( convert xc: -format "%[fx:$SIZE*.035]" info: )

    convert -size ${SIZE}x${SIZE} \
	xc:white \
	\( \
            -background none  -stroke black -fill black \
            -font EB-Garamond-08-Regular -pointsize $VERSION_SIZE \
	    -gravity NorthEast label:42 \
            -geometry +$VERSION_X-$VERSION_Y \
        \) \
	-composite \
	-flatten \
	"${LOGO_IMG[@]}" \
        -layers flatten \
        $ASSETS/the_underbar-001-${SIZE}px.png
    
done
